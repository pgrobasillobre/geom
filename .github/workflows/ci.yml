# .github/workflows/ci.yml
#
# Continuous Integration (CI) for GEOM.
#
# What this does:
# - On every Pull Request and every push to master,
#   GitHub Actions creates a fresh Linux machine,
#   installs your project and required dependencies,
#   and runs your test suite.
#
# Why this is useful:
# - It catches "works on my machine" problems early.
# - It prevents merging code that breaks installation/import/tests.
#
# Your current CI failure was:
#   ModuleNotFoundError: No module named 'gmsh'
# because geom/functions/create_geom.py imports gmsh at import-time.
# So we install the Python gmsh package explicitly in CI.

name: CI

on:
  # Run CI for every pull request (so checks run before merging)
  pull_request:

  # Also run CI for every push to the main branch
  push:
    # Your repo uses "master" as the default branch (adjust if you rename to "main")
    branches: ["master"]

jobs:
  test:
    # Use a fresh Ubuntu runner (clean environment each time)
    runs-on: ubuntu-latest

    strategy:
      # If one Python version fails, keep running the others.
      # This helps you see if the failure is version-specific.
      fail-fast: false

      # Run the same job on multiple Python versions
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      # 1) Check out your repository code onto the runner.
      # Without this, the runner has no code to test.
      - name: Checkout repository
        uses: actions/checkout@v5

      # 2) Install the selected Python version for this matrix run.
      # cache: "pip" speeds up repeated runs by caching downloaded wheels.
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      # 3) Install your package.
      # -e . installs in "editable" mode (good for testing source trees).
      # If your packaging metadata is broken, CI will fail here.
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      # 4) Install runtime dependency needed at import-time.
      # Your tests import geom.functions.create_geom which does `import gmsh`.
      # If gmsh is not installed, pytest fails during collection (before tests run).
      #
      # Pinning to your documented version reduces surprises.
      - name: Install gmsh (Python module)
        run: |
          python -m pip install gmsh==4.11.1

      # OPTIONAL: If later you discover gmsh needs system libraries on ubuntu-latest,
      # you can install the system package too (uncomment if needed).
      #
      # - name: Install system dependency (gmsh binary) if needed
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y gmsh

      # 5) Run your tests.
      # Your repo already provides this script, which likely calls pytest internally.
      - name: Run tests
        run: |
          chmod +x ./geom/tests/run_all_tests.sh
          ./geom/tests/run_all_tests.sh

